<!DOCTYPE html>
<html lang='en'>

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/styles/OrderDrinks.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <title>Lets Take The Order</title>
    <style type="text/css">
        * {
            font-family: sans-serif;
        }
    </style>
</head>


<body>
    <h1>Choose your Beer wisely</h1>
    <div class="container">
        {% for i in range(0, beers|length) %}
        {% if i % 3 == 0 %}
        {% if i != 0 %}
    </div>
    {% endif %}
    <div class="row">
        {% endif %}
        <div class="col-4">
            <button class="buttons" onclick=incrAmount("{{ beers[i] }}") style="color:{{ colorSet[i] }}">{{ beers[i]
                }}</button>
        </div>
        {% endfor %}
    </div>
    </div>
    <table class="table checkout">
        <thead>
            <tr>
                <th scope="col">Drink</th>
                <th scope="col">Price</th>
                <th scope="col">Amount</th>
                <th scope="col">Remove One</th>
            </tr>
        </thead>
        <tbody id="table_body">
        </tbody>
    </table>
    <div class="container">
        <div class="row">
            <div class="col-4">
            </div>
            <div class="col-4">
                <span class="total">Total: </span>
                <span class="total" id="total_price">0</span>
                <span class="total"> Euros </span>
                <input class="btn btn-primary" type="submit" value="Submit" onclick="submit()">
            </div>
            <div class="col-4">
            </div>
        </div>

    </div>


    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script>
        let beerList = {};

        const socket = new WebSocket('ws://' + location.host + '/echo');
        console.log('ws://' + location.host + '/echo')

        //receive message
        socket.addEventListener('message', ev => {
            //console.log(typeof ev.data)
            if (ev.data != "TABLE") {
                //console.log('NEW DATA!!!')
                beerList = JSON.parse(ev.data);
                console.log(ev.data)
                updateTable();
            }
        });

        socket.addEventListener('open', (event) => {
            socket.send('TABLE');
        });

        function updateTable() {
            if (!document.getElementById("table_body").innerHTML.replace(/\s/g, '')) {
                printTable();
            } else {
                for (let drink in beerList) {
                    let price = String(beerList[drink]["price"])
                    if (!price.includes(".")) {
                        price = price + ".0"
                    }
                    document.getElementById(drink + "_price").innerText = price + "0"; // update prices
                }
            }
        }

        function printTable() {
            let table_body = ""
            for (let drink in beerList) {
                table_body += "<tr>"
                table_body += "<td id=" + drink + ">" + drink + "</td>"
                table_body += "<td id=" + drink + "_price>" + beerList[drink]["price"] + "</td>"
                table_body += "<td id=" + drink + "_amount>0 </td>"
                table_body += "<td><i class=\"icon-remove-sign\" onclick=decrAmount(\"" + drink + "\")></i></td>"
                table_body += "</tr>"
            }
            document.getElementById("table_body").innerHTML = table_body;
        }

        function incrAmount(drink) {
            let id = drink + "_amount";
            let current = parseFloat(document.getElementById(id).innerText);
            document.getElementById(id).innerText = String(current + 1);
            calc_total();
        }

        function decrAmount(drink) {
            let id = drink + "_amount";
            let current = parseFloat(document.getElementById(id).innerText);
            if (current > 0) {
                document.getElementById(id).innerText = String(current - 1);
            }
            calc_total();
        }

        function clearOldOrder() {
            for (let drink in beerList) {
                document.getElementById(drink + "_amount").innerText = "0"; // set amounts to zero
            }
            document.getElementById("total_price").innerText = "0"; // set total to 0 because a new order starts
        }

        function calc_total() {
            let total = 0;
            for (let drink in beerList) {
                total += parseFloat(document.getElementById(drink + "_amount").innerText) * parseFloat(document.getElementById(drink + "_price").innerText);
            }
            total = Math.round(total * 10) / 10;//round to one decimal
            document.getElementById("total_price").innerText = String(total);
        }

        function submit() {
            purchased_drinks = [];
            for (let drink in beerList) {
                let amount_bought = parseInt(document.getElementById(drink + "_amount").innerText);
                for (let i = 0; i < amount_bought; i++) {
                    purchased_drinks.push(drink);
                }
            }
            sendRequest(purchased_drinks);
            clearOldOrder();
        }

        function sendRequest(ids) {
            if (!Array.isArray(ids) || ids.length === 0) {
                console.error("Error: 'ids' must be a non-empty array.");
                return;
            }
            $.ajax({
                url: 'http://127.0.0.1:8000/ordered_Drink/',
                method: 'POST',
                data: { 'names[]': ids },  // Send as an array
                traditional: true,  // Prevent jQuery from modifying array serialization
                success: function (response) {
                    console.log("Success:", response);
                },
                error: function (xhr, status, error) {
                    console.error("Error:", error);
                }
            });
        }
    </script>


    </div>
</body>

</html>
<!DOCTYPE html>
<html lang='en'>

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/styles/OrderDrinks.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <title>Bestellung Aufnehmen</title>
    <style type="text/css">
        * {
            font-family: sans-serif;
        }
    </style>
</head>


<body>
    <h1>Getränke Bestellen</h1>
    <div class="container-fluid">
        <div class="drink-grid">
            {% for i in range(0, beers|length) %}
            <div class="drink-card" onclick="incrAmount('{{ beers[i] }}')" style="--drink-color: {{ colorSet[i] }}">
                <div class="drink-name" style="color: {{ colorSet[i] }}">{{ beers[i] }}</div>
                <div class="drink-price-tag" id="{{ beers[i] }}_price_card">Laden...</div>
                <div class="drink-badge" id="{{ beers[i] }}_card_amount" style="display:none;">0</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="checkout-container">
        <div class="container">
            <div class="row align-items-center mb-3">
                <div class="col-12">
                    <table class="table checkout">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Getränk</th>
                                <th scope="col">Preis</th>
                                <th scope="col">Menge</th>
                                <th scope="col">Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="table_body">
                            {% for i in range(0, beers|length) %}
                            <tr id="row_{{ beers[i] }}" style="display:none;">
                                <td id="{{ beers[i] }}">{{ beers[i] }}</td>
                                <td id="{{ beers[i] }}_price">Laden...</td>
                                <td id="{{ beers[i] }}_amount">0</td>
                                <td><i class="icon-remove-sign" onclick="decrAmount('{{ beers[i] }}')"></i></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row align-items-center">
                <div class="col-md-4 text-center text-md-start">
                    <span id="alcohol_counter">Alkohol insgesamt: 0 ml</span>
                </div>
                <div class="col-md-4 text-center">
                    <div class="total-display">
                        Gesamt: <span id="total_price">0,00</span> €
                    </div>
                </div>
                <div class="col-md-4 text-center text-md-end">
                    <button class="btn btn-primary btn-submit" type="submit" onclick="submit()">
                        Bestellen <i class="icon-ok"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script>
        let beerList = {};

        const socket = new WebSocket('ws://' + location.host + '/echo');
        console.log('ws://' + location.host + '/echo')

        //receive message
        socket.addEventListener('message', ev => {
            //console.log(typeof ev.data)
            if (ev.data != "TABLE") {
                let msg = JSON.parse(ev.data);
                if (msg.type === "ALCOHOL") {
                    document.getElementById("alcohol_counter").innerText = "Alkohol insgesamt ausgeschenkt: " + parseFloat(msg.value).toFixed(2).replace('.', ',') + " ml";
                } else {
                    beerList = msg;
                    console.log(ev.data)
                    updateTable();
                }
            }
        });

        socket.addEventListener('open', (event) => {
            socket.send('TABLE');
        });

        function updateTable() {
            // Update the prices on the CARDS
            for (let drink in beerList) {
                let price = String(beerList[drink]["price"])
                if (!price.includes(".")) {
                    price = price + ".0"
                }
                // Update the card price
                // Update the card price
                let cardPriceFn = document.getElementById(drink + "_price_card");
                if (cardPriceFn) cardPriceFn.innerText = price.replace('.', ',') + "0 €";

                // ALSO update the table list price (crucial for calc_total and display)
                let tablePriceFn = document.getElementById(drink + "_price");
                if (tablePriceFn) tablePriceFn.innerText = price.replace('.', ',') + "0";


            }
        }

        function incrAmount(drink) {
            console.log("Clicked: " + drink);
            let id = drink + "_amount";
            let el = document.getElementById(id);
            if (!el) {
                console.error("Element not found: " + id);
                return;
            }
            let current = parseFloat(el.innerText);
            el.innerText = String(current + 1);

            updateCardBadge(drink, current + 1);
            updateRowVisibility(drink);
            calc_total();
        }

        function decrAmount(drink) {
            let id = drink + "_amount";
            let el = document.getElementById(id);
            let current = parseFloat(el.innerText);
            if (current > 0) {
                el.innerText = String(current - 1);
            }
            updateCardBadge(drink, current - 1);
            updateRowVisibility(drink);
            calc_total();
        }

        function updateCardBadge(drink, amount) {
            let badge = document.getElementById(drink + "_card_amount");
            if (badge) {
                badge.innerText = amount;
                badge.style.display = amount > 0 ? "flex" : "none";
            }
        }

        function updateRowVisibility(drink) {
            let amountId = drink + "_amount";
            let rowId = "row_" + drink;
            let amount = parseFloat(document.getElementById(amountId).innerText);
            let row = document.getElementById(rowId);

            if (amount > 0) {
                row.style.display = "table-row";
            } else {
                row.style.display = "none";
            }
        }

        function clearOldOrder() {
            const rows = document.querySelectorAll('tr[id^="row_"]');
            rows.forEach(row => {
                let drink = row.id.replace("row_", "");
                document.getElementById(drink + "_amount").innerText = "0"; // set amounts to zero
                updateCardBadge(drink, 0);
                updateRowVisibility(drink); // Hide the rows again
            });
            document.getElementById("total_price").innerText = "0,00"; // set total to 0 because a new order starts
        }

        function calc_total() {
            let total = 0;
            for (let drink in beerList) {
                total += parseFloat(document.getElementById(drink + "_amount").innerText) * parseFloat(document.getElementById(drink + "_price").innerText.replace(',', '.'));
            }
            total = Math.round(total * 10) / 10; //round to one decimal
            document.getElementById("total_price").innerText = total.toFixed(2).replace('.', ',');
        }

        function submit() {
            purchased_drinks = [];
            // We need to iterate over the actual DOM elements because beerList might be outdated or empty if socket failed
            // Actually, let's use the 'beers' list from Jinja via the DOM rows we know exist
            const rows = document.querySelectorAll('tr[id^="row_"]');

            rows.forEach(row => {
                let drink = row.id.replace("row_", "");
                let amountId = drink + "_amount";
                let amount_bought = parseInt(document.getElementById(amountId).innerText);
                for (let i = 0; i < amount_bought; i++) {
                    purchased_drinks.push(drink);
                }
            });

            if (purchased_drinks.length > 0) {
                sendRequest(purchased_drinks);
                clearOldOrder();
            } else {
                console.log("No drinks selected");
            }
        }

        function sendRequest(ids) {
            if (!Array.isArray(ids) || ids.length === 0) {
                console.error("Error: 'ids' must be a non-empty array.");
                return;
            }
            $.ajax({
                url: 'http://127.0.0.1:8000/ordered_Drink/',
                method: 'POST',
                data: { 'names[]': ids },  // Send as an array
                traditional: true,  // Prevent jQuery from modifying array serialization
                success: function (response) {
                    console.log("Success:", response);
                },
                error: function (xhr, status, error) {
                    console.error("Error:", error);
                }
            });
        }
    </script>


    </div>
</body>

</html>